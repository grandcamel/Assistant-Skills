version: '3.8'

services:
  e2e-tests:
    build:
      context: ../..
      dockerfile: docker/e2e/Dockerfile
    environment:
      # Primary authentication method
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}

      # Alternative: Claude Code OAuth (if user has logged in)
      # Mount ~/.claude for OAuth credentials

      # Test configuration
      - E2E_TEST_TIMEOUT=${E2E_TEST_TIMEOUT:-120}
      - E2E_TEST_MODEL=${E2E_TEST_MODEL:-claude-sonnet-4-20250514}
      - E2E_MAX_TURNS=${E2E_MAX_TURNS:-5}
      - E2E_VERBOSE=${E2E_VERBOSE:-false}

      # Claude Code settings
      - CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC=1
      - CLAUDE_CODE_SKIP_OOBE=1
      - CI=true
    volumes:
      # Mount test results
      - ../../test-results/e2e:/workspace/test-results

      # Claude Code needs a writable .claude directory for runtime data
      # We use a named volume to persist across runs but not affect host
      - claude-data:/home/testuser/.claude

      # Optional: Mount host .claude directory for OAuth credentials
      # The entrypoint will copy credentials.json if present
      # Comment out if using only API key authentication
      # - ${HOME}/.claude:/tmp/claude-credentials:ro
    working_dir: /workspace/plugin-source

    # Resource limits
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

  # Interactive shell for debugging
  e2e-shell:
    build:
      context: ../..
      dockerfile: docker/e2e/Dockerfile
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC=1
      - CLAUDE_CODE_SKIP_OOBE=1
      - CI=true
    volumes:
      - ../..:/workspace/plugin-source
      - claude-data:/home/testuser/.claude
      # Optional: Mount host .claude directory for OAuth credentials
      # - ${HOME}/.claude:/tmp/claude-credentials:ro
    working_dir: /workspace/plugin-source
    stdin_open: true
    tty: true
    entrypoint: /bin/bash
    profiles:
      - debug

# Named volumes for Claude Code runtime data
volumes:
  claude-data:
